generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String              @id @default(uuid())
  email               String              @unique
  garminUserId        String?             @unique
  accessToken         String?
  refreshToken        String?
  tokenExpiresAt      DateTime?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  name                String?
  avatarUrl           String?
  emailVerified       DateTime?
  passwordHash        String?
  age                 Int?
  location            String?
  onboardingCompleted Boolean             @default(false)
  activeDataSource    AuthProvider?
  stravaUserId        String?             @unique
  role                UserRole            @default(FREE)
  mustChangePassword  Boolean             @default(false)
  activatedAt         DateTime?
  activatedBy         String?
  bikes               Bike[]
  components          Component[]
  tokens              OauthToken[]
  rides               Ride[]
  stravaGearMappings  StravaGearMapping[]
  accounts            UserAccount[]
}

model OauthToken {
  id           String       @id @default(cuid())
  userId       String
  accessToken  String
  refreshToken String?
  expiresAt    DateTime
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  provider     AuthProvider
  User         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
}

model UserAccount {
  id             String       @id @default(cuid())
  userId         String
  provider       AuthProvider
  providerUserId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerUserId])
  @@index([userId])
}

model Ride {
  id                String   @id @default(uuid())
  userId            String
  garminActivityId  String?  @unique
  startTime         DateTime
  durationSeconds   Int
  averageHr         Int?
  rideType          String
  bikeId            String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  distanceMiles     Float
  elevationGainFeet Float
  notes             String?
  location          String?
  trailSystem       String?
  duplicateOfId     String?
  isDuplicate       Boolean  @default(false)
  stravaActivityId  String?  @unique
  stravaGearId      String?
  bike              Bike?    @relation(fields: [bikeId], references: [id])
  duplicateOf       Ride?    @relation("DuplicateRides", fields: [duplicateOfId], references: [id])
  duplicates        Ride[]   @relation("DuplicateRides")
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Bike {
  id                 String              @id @default(uuid())
  userId             String
  nickname           String?
  manufacturer       String
  model              String
  travelForkMm       Int?
  travelShockMm      Int?
  notes              String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  year               Int?
  spokesId           String?
  buildKind          String?
  category           String?
  family             String?
  frameMaterial      String?
  gender             String?
  hangerStandard     String?
  isEbike            Boolean             @default(false)
  isFrameset         Boolean             @default(false)
  spokesUrl          String?
  subcategory        String?
  batteryWh          Int?
  motorMaker         String?
  motorModel         String?
  motorPowerW        Int?
  motorTorqueNm      Int?
  thumbnailUrl       String?
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  components         Component[]
  Ride               Ride[]
  stravaGearMappings StravaGearMapping[]

  @@index([spokesId])
}

model StravaGearMapping {
  id             String   @id @default(uuid())
  userId         String
  stravaGearId   String
  stravaGearName String?
  bikeId         String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  bike           Bike     @relation(fields: [bikeId], references: [id], onDelete: Cascade)
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, stravaGearId])
  @@index([userId])
  @@index([bikeId])
}

model Component {
  id                String        @id @default(uuid())
  bikeId            String?
  type              ComponentType
  brand             String
  model             String
  installedAt       DateTime?
  hoursUsed         Float         @default(0)
  serviceDueAtHours Float?
  notes             String?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  isStock           Boolean       @default(false)
  userId            String
  bike              Bike?         @relation(fields: [bikeId], references: [id])
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([bikeId])
}

enum AuthProvider {
  garmin
  google
  strava
}

enum UserRole {
  WAITLIST
  FREE
  PRO
  ADMIN
}

enum ComponentType {
  FORK
  SHOCK
  BRAKES
  DRIVETRAIN
  TIRES
  WHEELS
  DROPPER
  PEDALS
  CHAIN
  CASSETTE
  OTHER
  PIVOT_BEARINGS
  STEM
  HANDLEBAR
  SADDLE
  SEATPOST
  RIMS
  CRANK
  REAR_DERAILLEUR
}
