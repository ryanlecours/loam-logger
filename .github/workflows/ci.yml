name: LoamLogger CI

on:
  push:
    branches: [main, dev]
    paths:
      - 'apps/**'
      - 'libs/**'
      - 'package.json'
      - 'package-lock.json'
      - 'nx.json'
      - 'tsconfig.base.json'
  pull_request:
    branches: [main, dev]
    paths:
      - 'apps/**'
      - 'libs/**'
      - 'package.json'
      - 'package-lock.json'
      - 'nx.json'
      - 'tsconfig.base.json'
  issue_comment:
    types: [created]

jobs:
  # Nx monorepo CI - runs affected projects only
  monorepo-ci:
    name: Nx Monorepo CI
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'pull_request' || github.event_name == 'push' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for Nx affected commands

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Clean nested node_modules (prevent native dep issues)
        run: |
          rm -rf apps/web/node_modules
          rm -rf apps/api/node_modules

      - name: Install dependencies
        run: npm ci --include=optional

      - name: Derive appropriate SHAs for base and head for Nx affected commands
        uses: nrwl/nx-set-shas@v4

      - name: Verify GraphQL generated files are committed
        run: |
          if [ ! -f "libs/graphql/src/generated/index.ts" ]; then
            echo "❌ Error: GraphQL generated files are missing!"
            echo "Run 'npm run codegen' locally and commit the generated files."
            exit 1
          fi
          echo "✅ GraphQL generated files are present"

      - name: Lint affected projects
        run: npx nx affected -t lint --parallel=3

      - name: Type check affected projects
        run: npx nx affected -t type-check --parallel=3 || echo "No type-check target defined"

      - name: Build affected projects
        run: npx nx affected -t build --parallel=3 --verbose

      - name: Validate Prisma schema (if API affected)
        run: |
          if npx nx show projects --affected | grep -q "api"; then
            cd apps/api && npx prisma validate
          else
            echo "API not affected, skipping Prisma validation"
          fi
        env:
          DATABASE_URL: postgresql://user:pass@localhost:5432/test

  # Claude PR Review - triggered by @claude review comment
  claude-pr-review:
    name: Claude PR Review (Haiku, manual on @claude review)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    # Only run when:
    # - Comment is on a PR (not an Issue)
    # - Comment contains "@claude review"
    # - Comment author is not a bot (optional but recommended)
    if: >
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request != null &&
      contains(github.event.comment.body, '@claude review') &&
      github.event.comment.user.type != 'Bot'

    steps:
      - name: Get PR base branch
        id: pr-info
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.issue.number;

            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });

            const isMain = pr.base.ref === 'main';
            core.info(`Base branch: ${pr.base.ref}`);
            core.setOutput('run_claude', isMain ? 'true' : 'false');

      - name: Claude PR review (Haiku, main branch only)
        if: steps.pr-info.outputs.run_claude == 'true'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: |
            --model claude-3-5-haiku-20241022
            --max-turns 6